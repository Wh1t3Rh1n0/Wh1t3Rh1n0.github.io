<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
    
    
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  

  
  <title>How I discovered CVE-2017-13707</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  
    <link rel="stylesheet" href="https://wh1t3rh1n0.github.io/css/code-blocks.css">
  

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  

  
  <link href="https://wh1t3rh1n0.github.io/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="Wh1t3Rh1n0">

  
  <meta name="generator" content="Hugo 0.40.1" />

  
  

  
  
</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="https://wh1t3rh1n0.github.io/">Wh1t3Rh1n0</a></h1>
    <h2>I will find a way, or I will make one.</h2>
</hgroup></header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
        <option value="https://wh1t3rh1n0.github.io/">» Blog</option>
      
        <option value="https://www.github.com/Wh1t3Rh1n0">» Github</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
    
      <li><a href="https://wh1t3rh1n0.github.io/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://www.github.com/Wh1t3Rh1n0" title="Github"  target="_blank" >Github</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="https://wh1t3rh1n0.github.io/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:https://wh1t3rh1n0.github.io/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Oct 5, 2017
    
    

    
    
      - <a class="label" href="https://wh1t3rh1n0.github.io/categories/exploits/">exploits </a><a class="label" href="https://wh1t3rh1n0.github.io/categories/linux/">linux </a>
    
  </p>
  <h1 class="entry-title">
     How I discovered CVE-2017-13707 
  </h1>
</header>


        <div class="entry-content">
          
          
          
          <p>One of the topics I teach in Coalfire&rsquo;s <a href="https://www.blackhat.com/us-17/training/adaptive-penetration-testing.html" target="_blank">Adaptive Penetration Testing</a> course, given most recently at Black Hat 2017, is manual privilege escalation on Linux- and Unix-based systems. I also talk about how common it is to gain an initial foothold in an environment by leveraging default or easily guessable login credentials. During a recent red team engagement, I leveraged both of these techniques – not only to fully compromise the organization&rsquo;s Active Directory environment, but also to discover and exploit a previously unknown vulnerability in the Replibit Linux distribution installed on a server on their network.</p>

<p></p>

<p>After delivering the report to our client, I contacted Replibit to responsibly disclose the issue and give them the opportunity to release a fix. They responded immediately and published a fix within a week of my initial contact. I was impressed with how quickly they responded, and it was a real pleasure working with their team. Since then, I&rsquo;ve publicly disclosed the vulnerability, which has been assigned the CVE number <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-13707" target="_blank">2017-13707</a>.</p>

<p>What follows is a brief walkthrough explaining how just a few of the exact same techniques I cover in our <a href="https://www.blackhat.com/us-17/training/adaptive-penetration-testing.html" target="_blank">Adaptive Penetration Testing</a> class were used to discover and exploit this vulnerability.</p>

<h2 id="getting-a-foothold-with-default-credentials">Getting a foothold with default credentials</h2>

<p>We gained access to the client&rsquo;s internal network through social engineering. The target office was located in a multi-tenant building, so a member of our team dressed up as an electrician and talked his way inside. He told the receptionist there had been a leak on the floor above, and now that it was fixed he needed to test the electrical outlets in the office to make sure there was no danger of anyone getting electrocuted. He walked around the office &ldquo;testing&rdquo; the electrical outlets, and during a brief moment when no one was looking, he plugged in a Raspberry Pi dropbox behind a printer in the office. After being plugged into the internal network, the dropbox made an encrypted connection over the Internet back to our command-and-control server. This provided us with the exact same level of access we would have if we were sitting inside the office, but with the convenience of 24/7 remote access from anywhere in the world. We could now come and go on the target network as we pleased.</p>

<p>In order to be as stealthy as possible, we didn&rsquo;t use vulnerability scanners or other tools that would use lots of bandwidth or generate suspicious traffic. Instead, we slowly identified hosts on the internal network and probed them for common services like HTTP. This led us to a server running the Replibit Backup Manager web interface. After browsing the login page, we did a simple web search to find Replibit&rsquo;s documentation, which contained the default username and password, both of which were &ldquo;replibit&rdquo;. However, when we tried logging in through the web interface, the login failed.</p>

<p><img src="/images/20171005/Replibit-login.jpg" alt="Login failed on the Replibit web interface" /></p>

<p>Fortunately for us, the Replibit server was also running SSH, and the default credentials let us login to that service on the first try.</p>

<p><img src="/images/20171005/Source-code-1.jpg" alt="Successful login to the Replibit SSH service" /></p>

<h2 id="escaping-the-restricted-shell">Escaping the restricted shell</h2>

<p>After logging in, I was presented with a restricted shell environment, which only allowed me to execute a limited subset of commands. Among the commands I had available were sudo and lsudo. Because sudo is a command that allows users to run other commands with elevated privileges (often root), these commands immediately caught my attention.</p>

<p><img src="/images/20171005/Source-code-2.jpg" alt="List of commands available from the Replibit shell" /></p>

<p>It turned out that the lsudo command was a built-in command within the restricted shell that listed other commands I was allowed to execute with sudo. This was useful since the usual &ldquo;sudo -l&rdquo; was not a command I was allowed to execute.</p>

<p>The screenshot below shows the output of the lsudo command. Among the commands listed were &ldquo;more&rdquo; and &ldquo;vi&rdquo;. These immediately stood out to me since both commands have often-overlooked features that can be used to escalate privileges when the commands are run via sudo.</p>

<p><img src="/images/20171005/Source-code-3.jpg" alt="List of commands that can be run via sudo" /></p>

<p>I tried some of the immediately obvious tricks like reading password hashes from /etc/shadow, modifying user accounts in /etc/passwd, and using internal commands (such as more&rsquo;s &ldquo;!/bin/bash&rdquo; and vi&rsquo;s &ldquo;:!/bin/bash&rdquo; and &ldquo;:shell&rdquo;) to execute privileged shells. However, it appeared that the Replibit team was aware of all of these techniques since none of them worked.</p>

<p><img src="/images/20171005/Source-code-4.jpg" alt="Initial attempts at privilege escalation failed" /></p>

<p>Although I couldn&rsquo;t open /etc/shadow or /etc/passwd directly from vi, I could open other files in the replibit user&rsquo;s home directory. This made me wonder if I could open an allowed path from the command line and then change to one of the forbidden files from within vi. To try this, I executed &ldquo;vi ~&ldquo;, which told vi to display the contents of the current user&rsquo;s home directory within its file browser interface.</p>

<p>From here I could use the arrow keys to move up and down the list of files and directories and the &ldquo;Enter&rdquo; key to select which one I wanted. I selected the first entry in the list, &ldquo;../&rdquo;, to move up to the parent directory.</p>

<p><img src="/images/20171005/Source-code-5.jpg" alt="Navigating to ../ with vi's file browser interface" /></p>

<p>Sure enough, this worked, and I was now presented with the contents of the &ldquo;/home&rdquo; directory.</p>

<p><img src="/images/20171005/Source-code-6.jpg" alt="Contents of the /home directory displayed in vi" /></p>

<p>I selected &ldquo;../&rdquo; to move into the parent directory again and then &ldquo;etc/&rdquo; to move into &ldquo;/etc/&rdquo;. Then I selected the shadow file and was immediately presented with the password hash of the root user account!</p>

<p><img src="/images/20171005/Source-code-7.jpg" alt="The root user's password hash contained in /etc/shadow" /></p>

<h2 id="becoming-root">Becoming root</h2>

<p>At this point I could have saved the hash locally and attempted to crack it with hashcat or a similar tool, but that&rsquo;s a potentially time-consuming process that may or may not have been successful. Instead, I took the much faster route of temporarily changing the root user&rsquo;s password to something else.</p>

<p>First, I backed up the root user&rsquo;s password hash so I could set it back to its original value after getting a shell. Then since I already knew the password of the replibit user, I just copied replibit&rsquo;s password hash and inserted it in place of root&rsquo;s password hash. After saving changes to the shadow file, I made a second ssh connection to the server and logged in with the username, &ldquo;root&rdquo;, and the password, &ldquo;replibit&rdquo;.</p>

<p><img src="/images/20171005/Source-code-8.jpg" alt="Successful login to the root account" /></p>

<p>After logging in, I changed the root user&rsquo;s password hash back to its original value – both to cover my tracks and to keep from causing any problems for users or software that might use the root account to login to this machine.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Exploiting the Replibit server turned out to be a huge success since, not only was I able to escalate privileges and fully compromise this machine, but gaining root access allowed me to access full backups of several different Windows servers in use on the internal network. By using sshfs to access the Replibit server&rsquo;s filesystem, I was able to mount the backup files remotely from the dropbox and extract the local password hashes from each. Then it was as easy as passing the hashes to gain administrative access to each Windows server and doing the Mimikatz shuffle to domain admin to fully compromise the whole domain.</p>
        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Wh1t3Rh1n0</span></span>
    
    <time>Oct 5, 2017</time>
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="https://wh1t3rh1n0.github.io/blog/2016-10-06-breaking-into-wpa-enterprise-networks-with-air-hammer/" title="Breaking into WPA Enterprise networks with Air-Hammer">Breaking into WPA Enterprise networks with Air-Hammer</a>
    

    
      <a class="basic-alignment right" href="https://wh1t3rh1n0.github.io/blog/2019-01-28-bypass-group-policy-to-decrypt-a-bitlocker-encrypted-drive/" title="Bypass Group Policy to Decrypt a BitLocker-Encrypted Drive">Bypass Group Policy to Decrypt a BitLocker-Encrypted Drive</a>
    
  </p>
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>Downloads</h1>
    

    <p>
      
        <a href="https://github.com/Wh1t3Rh1n0/air-hammer" target="_blank">Air-Hammer</a><br />
<a href="https://www.dropbox.com/sh/6cy883gyicww8py/AAA3kBSRIjfZRvn2H1BG0xkga" target="_blank">WoNDeR-List</a><br />
<a href="/files/Wireless Hacking Cheat Sheet v1.1.pdf">Wireless Cheat-Sheet</a>
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" href="https://github.com/Wh1t3Rh1n0/" title="https://github.com/Wh1t3Rh1n0/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" href="https://twitter.com/Wh1t3Rh1n0/" title="https://twitter.com/Wh1t3Rh1n0/"><i class="fa fa-twitter fa-3x"></i></a>
      
         
      
      <a target="_blank" href="https://www.linkedin.com/in/wh1t3rh1n0" title="https://www.linkedin.com/in/wh1t3rh1n0"><i class="fa fa-linkedin fa-3x"></i></a>
      
      
      
      
      
      

    
    
    </li>
  </ul>

  

  
    
      <section class="odd">
        
          <h1>Categories</h1>
        
        
          <li>
            <a href="https://wh1t3rh1n0.github.io/categories/exploits" title="Exploits" >Exploits</a>
          </li>
        
          <li>
            <a href="https://wh1t3rh1n0.github.io/categories/full-disk-encryption" title="Full disk encryption" >Full disk encryption</a>
          </li>
        
          <li>
            <a href="https://wh1t3rh1n0.github.io/categories/wireless" title="Wireless" >Wireless</a>
          </li>
        
      </section>
    
  

  
  
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
          
            
              <li class="post">
                <a href="/blog/2019-01-28-bypass-group-policy-to-decrypt-a-bitlocker-encrypted-drive/">Bypass Group Policy to Decrypt a BitLocker-Encrypted Drive</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2017-10-05-how-i-discovered-cve-2017-13707/">How I discovered CVE-2017-13707</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2016-10-06-breaking-into-wpa-enterprise-networks-with-air-hammer/">Breaking into WPA Enterprise networks with Air-Hammer</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2014-07-04-new-version-of-wonder-list-released/">New version of WoNDeR-List released!</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2014-06-16-introducing-wonder-list/">Introducing WoNDeR-List</a>
              </li>
            
          
            
          
        </ul>
      </section>
    
  
</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2019 Wh1t3Rh1n0 - <a href="https://wh1t3rh1n0.github.io/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
      </p>
    </footer>

    
    
    

    
      <script>
        var _gaq=[['_setAccount','UA-85360780-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
      </script>
    
  </body>
</html>

